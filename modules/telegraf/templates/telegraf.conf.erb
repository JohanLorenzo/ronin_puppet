# Telegraf Configuration
<% if @global_tags -%>
[global_tags]
<%   @global_tags.sort.each do |key, value| -%>
  <%= key %> = "<%= value %>"
<%   end -%>
<% end -%>

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 5000
  metric_buffer_limit = 20000
  collection_jitter = "300s"
  flush_interval = "120s"
  flush_jitter = "0s"
  precision = "s"
  debug = false
  quiet = false
  logfile = ""
  omit_hostname = false

[[outputs.influxdb]]
  urls = ["<%= @influxdb_url %>"]
  database = "relops"
  #skip_database_creation = true
  username = "<%= @influxdb_username %>"
  password = "<%= @influxdb_password %>"
  retention_policy = ""
  write_consistency = "any"
  timeout = "120s"

[[inputs.cpu]]
  ## Whether to report per-cpu stats or not
  percpu = true
  ## Whether to report total system cpu stats or not
  totalcpu = true
  ## If true, collect raw CPU time metrics.
  collect_cpu_time = false
  ## If true, compute and report the sum of all non-idle CPU states.
  report_active = false

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs"]

[[inputs.diskio]]

[[inputs.mem]]

[[inputs.swap]]

[[inputs.system]]

<% if scope.lookupvar('::operatingsystem') == 'Darwin' -%>
[[inputs.exec]]
  commands = [
    "/bin/bash -c \"printf \\\"thermal %sboottime=$(/usr/sbin/sysctl -n kern.boottime | cut -d' ' -f4 | cut -d',' -f1)s\\\" $(/usr/bin/pmset -g therm | awk $'/=/{printf $1$2$3\\\",\\\"}')\""
  ]
  timeout = "60s"
  data_format = "influx"

[[inputs.exec]]
  commands = [
    "/bin/bash -c \"printf \\\"thermal %sboottime=$(/usr/sbin/sysctl -n kern.boottime | cut -d' ' -f4 | cut -d',' -f1)s\\\" $(/usr/sbin/sysctl -ie machdep.xcpm.cpu_thermal_level machdep.xcpm.gpu_thermal_level machdep.xcpm.io_thermal_level | awk $'/=/{printf $1$2$3\\\",\\\"}')\""
  ]
  timeout = "60s"
  data_format = "influx"
<% else -%>
[[inputs.temp]]

[[inputs.hddtemp]]
<% end -%>

[[inputs.filecount]]
<% if scope.lookupvar('::operatingsystem') == 'Darwin' -%>
  directories = ["/Users/task*"]
<% else -%>
  directories = ["/home/task*"]
<% end -%>
  tagexclude = ["directory"]

[[inputs.procstat]]
  exe = "generic-worker"

