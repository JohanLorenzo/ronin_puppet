#!/bin/bash

# This is a wrapper script for calling generic worker, such that when the worker
# exits, this script will reboot the machine.

(find /private/var/folders/ -nouser -delete; echo "Finished clearing old cache files" ) &

<% if scope.lookupvar('::operatingsystem') == 'Darwin' -%>
exec 1> >(tee /var/log/genericworker/stdout.log >&1)
exec 2> >(tee /var/log/genericworker/stderr.log >&2)
<% end %>

# First run the generic-worker, passing through any arguments handed to this
# wrapper script...
<% if scope.lookupvar('::operatingsystem') == 'Darwin' -%>
/usr/local/bin/generic-worker "$@"
<% else %>
/usr/local/bin/generic-worker "$@" 2>&1 | logger -t generic-worker -s
<% end %>

exitstatus="${PIPESTATUS[0]}"

# Remove semaphore file to ensure generic worker does not start before puppet
rm -rf "/var/tmp/semaphore/run-buildbot"

export TASKCLUSTER_CLIENT_ID="<%= @quarantine_client_id %>"
export TASKCLUSTER_ACCESS_TOKEN="<%= @quarantine_access_token %>"

if [ $exitstatus -eq 69 ]; then
# If generic-worker considers that the host environment is in an invalid/corrupted
# state (for example, it cannot write to disk), it will return the exit code 69.
#
# More information about generic-worker exit codes can be seen here:
# https://docs.taskcluster.net/docs/reference/workers/generic-worker#set-up-your-env
#
# If this happens, we make a call to Taskcluster Queue to quarantine the worker, so
# that no further tasks will be provided to the worker until the quarantine expires.
# This prevents the worker from burning through tasks that it is not able to execute
# properly.
    if [ -f <%= @user_homedir %>/quarantined ]; then
        echo "Worker is quarantined"
    else
        echo "Quarantine worker"
        # quarantine the worker using github.com/mozilla-platform-ops/quarantine-worker CLI
        /usr/local/bin/quarantine-worker releng-hardware "<%= @worker_type %>" "<%= @worker_group %>" "<%= @hostname %>" 720h5s

        # create a semaphore file
        echo "quarantined worker" > <%= @user_homedir %>/quarantined
    fi
elif [ $exitstatus -gt 69 -o $exitstatus -lt 69 ]; then
    # If exitstatus is different by 69 (grater than 69 or lower than 69)
    # The worker was removed from the quarantin and run with success a job
    # Remove quarantined file, if file exist
    if [ -f <%= @user_homedir %>/quarantined ]; then
        /bin/rm -rf <%= @user_homedir %>/quarantined
    fi
    # Now reboot the machine immediately (time costs money)
    <%= @reboot_command %>
    # Sleep to prevent this script from terminating naturally, and launchd restarting
    # it. Instead, the shutdown should cause this script to terminate (so it won't
    # really sleep for 2 mins). If shutdown doesn't kick in within 2 mins, it is sane
    # for this script to exit, and allow launchd to fire up the worker again.
    /bin/sleep 120
fi
